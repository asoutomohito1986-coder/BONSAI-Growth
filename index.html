<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BONSAI GROWTH AI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/@coinbase/wallet-sdk@3.7.1/dist/index.js"></script>
    <style>
        body { text-align: center; background: #222; color: #fff; font-family: sans-serif; margin: 0; padding: 0; }
        #title-screen { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #0052FF; }
        #game-screen { display: none; background: #f0f0f0; color: #333; min-height: 100vh; padding: 20px; }
        
        .card-row { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 10px; border-radius: 10px; flex: 1; max-width: 150px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .num { font-size: 20px; font-weight: bold; color: #2e7d32; }

        #bonsai-view { 
            width: 250px; height: 250px; background: #ddd; margin: 20px auto; 
            border-radius: 15px; display: flex; align-items: center; justify-content: center;
            overflow: hidden; border: 4px solid #fff; position: relative;
        }
        #bonsai-view img { width: 100%; height: 100%; object-fit: cover; }
        
        .btn { padding: 15px 25px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; margin: 5px; }
        .btn-blue { background: #fff; color: #0052FF; }
        .btn-green { background: #4caf50; color: #fff; }
        .btn-orange { background: #ff9800; color: #fff; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        #loading-text { position: absolute; color: #666; font-size: 12px; display: none; }
    </style>
</head>
<body>

    <div id="title-screen">
        <div style="font-size: 60px;">ğŸŒ²</div>
        <h1>BONSAI GROWTH</h1>
        <button id="connect-btn" class="btn btn-blue">Wallet Connect</button>
    </div>

    <div id="game-screen">
        <div class="card-row">
            <div class="stat-card"><div>GP</div><div id="gp-val" class="num">0</div></div>
            <div class="stat-card"><div>æ¨¹é½¢</div><div id="age-val" class="num">0</div></div>
        </div>

        <div id="bonsai-view">
            <span id="loading-text">AIç”Ÿæˆä¸­...</span>
            <div id="bonsai-img-container" style="font-size: 80px;">ğŸŒ±</div>
        </div>

        <button class="btn btn-green" onclick="water()">ğŸ’§ æ°´ã‚„ã‚Š (+10GP)</button>
        <button id="grow-btn" class="btn btn-orange" onclick="grow()" disabled>âœ¨ æˆé•· (50GP)</button>
        
        <p id="info-msg" style="margin-top: 15px; font-size: 14px; color: #666;"></p>
        <div id="death-msg" style="color: red; font-size: 12px;"></div>
        <button onclick="resetAll()" style="margin-top: 30px; opacity: 0.2; background: none; border: none;">[Reset]</button>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        var userAddr = "";
        var myGP = 0;
        var myAge = 0;
        var lastWaterTime = Date.now();
        var myImg = "";

        // ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶š
        async function connectWallet() {
            if (!window.ethereum) {
                alert("Coinbase Walletã‚¢ãƒ—ãƒªã§é–‹ã„ã¦ãã ã•ã„");
                return;
            }
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddr = accounts[0];
                loadData();
                document.getElementById('title-screen').style.display = 'none';
                document.getElementById('game-screen').style.display = 'block';
                updateUI();
            } catch (e) {
                alert("æ¥ç¶šã‚¨ãƒ©ãƒ¼: " + e.message);
            }
        }

        // æ°´ã‚„ã‚Š
        function water() {
            myGP += 10;
            lastWaterTime = Date.now();
            document.getElementById('info-msg').innerText = "æ°´ã‚’ã‚ã’ã¾ã—ãŸï¼(+10GP)";
            saveData();
            updateUI();
        }

        // æˆé•·ï¼ˆAIç”»åƒç”Ÿæˆï¼‰
        async function grow() {
            if (myGP < 50) return;
            myGP -= 50;
            myAge += 5;

            const loader = document.getElementById('loading-text');
            const container = document.getElementById('bonsai-img-container');
            const btn = document.getElementById('grow-btn');

            loader.style.display = "block";
            container.style.opacity = "0.3";
            btn.disabled = true;

            // AIç”»åƒURLç”Ÿæˆ (Pollinationsã‚’ä½¿ç”¨)
            const seed = Math.floor(Math.random() * 10000);
            const prompt = encodeURIComponent("bonsai tree, hyper-detailed, zen style, white background");
            const newUrl = "https://image.pollinations.ai/prompt/" + prompt + "?seed=" + seed + "&width=300&height=300&nologo=true";

            // ç”»åƒã®èª­ã¿è¾¼ã¿ç¢ºèª
            const testImg = new Image();
            testImg.src = newUrl;
            testImg.onload = function() {
                myImg = newUrl;
                container.innerHTML = '<img src="' + newUrl + '">';
                container.style.opacity = "1";
                loader.style.display = "none";
                document.getElementById('info-msg').innerText = "AIãŒæ–°ã—ã„å§¿ã‚’æãã¾ã—ãŸï¼";
                saveData();
                updateUI();
            };
            testImg.onerror = function() {
                loader.innerText = "ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã€‚";
                btn.disabled = false;
            };
        }

        // ã‚»ãƒ¼ãƒ–ãƒ»ãƒ­ãƒ¼ãƒ‰
        function saveData() {
            const obj = { gp: myGP, age: myAge, water: lastWaterTime, img: myImg };
            localStorage.setItem('bonsai_save_' + userAddr, JSON.stringify(obj));
        }

        function loadData() {
            const saved = localStorage.getItem('bonsai_save_' + userAddr);
            if (saved) {
                const data = JSON.parse(saved);
                myGP = data.gp || 0;
                myAge = data.age || 0;
                lastWaterTime = data.water || Date.now();
                myImg = data.img || "";
            }
        }

        // UIæ›´æ–°
        function updateUI() {
            document.getElementById('gp-val').innerText = myGP;
            document.
