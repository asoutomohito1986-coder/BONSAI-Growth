<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BONSAI GROWTH - System v3.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/@coinbase/wallet-sdk@3.7.1/dist/index.js"></script>
    <style>
        body { text-align: center; background: #f4f4f2; font-family: sans-serif; margin: 0; }
        #title-screen { background: #0052FF; color: white; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #game-screen { display: none; padding: 20px; }

        .status-card { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: inline-block; min-width: 280px; }
        .gp-display { font-size: 32px; color: #2e7d32; font-weight: bold; }
        
        /* ç›†æ ½ã¨ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .bonsai-box { font-size: 120px; margin: 40px 0; position: relative; display: inline-block; }
        @keyframes shine {
            0% { text-shadow: 0 0 0px #fff; }
            50% { text-shadow: 0 0 30px #ffeb3b, 0 0 50px #ffeb3b; }
            100% { text-shadow: 0 0 0px #fff; }
        }
        .shine-effect { animation: shine 0.8s ease-in-out; }

        /* ãƒœã‚¿ãƒ³ */
        .btn { padding: 15px 30px; border-radius: 50px; border: none; cursor: pointer; font-weight: bold; margin: 5px; font-size: 18px; }
        .btn-water { background: #4caf50; color: white; }
        .btn-grow { background: #ff9800; color: white; }
        .btn-grow:disabled { background: #ccc; cursor: not-allowed; }

        #death-timer { color: #d32f2f; font-size: 12px; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="title-screen">
        <div style="font-size: 80px;">ğŸŒ²</div>
        <h1>BONSAI GROWTH</h1>
        <button id="connect-btn" class="btn" style="background: white; color: #0052FF;">ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶š</button>
    </div>

    <div id="game-screen">
        <div class="status-card">
            <div id="state-badge" style="font-size: 14px; font-weight: bold; color: #666;">çŠ¶æ…‹: è‰¯å¥½</div>
            <div class="gp-display"><span id="gp-value">0</span> GP</div>
            <div style="font-size: 14px;">æ¨¹é½¢ï¼ˆè©•ä¾¡å€¤ï¼‰: <span id="age-display">0</span> å¹´</div>
            <div id="death-timer"></div>
        </div>

        <div class="bonsai-box" id="bonsai-display">ğŸŒ²</div>
        
        <div>
            <button class="btn btn-water" id="water-btn" onclick="actionWater()">ğŸ’§ æ°´ã‚„ã‚Š (+10GP)</button>
            <button class="btn btn-grow" id="grow-btn" onclick="actionGrow()" disabled>âœ¨ æˆé•· (è¦50GP)</button>
        </div>

        <p id="msg-box" style="margin-top: 20px; font-weight: bold; color: #333;"></p>
        <p id="wallet-addr" style="font-size: 10px; opacity: 0.5; margin-top: 40px;"></p>
        <button onclick="resetGame()" style="opacity: 0.2; border: none; background: none;">[ãƒªã‚»ãƒƒãƒˆ]</button>
    </div>

    <script>
        let userAddress = "";
        let gp = 0;
        let lastWatered = Date.now();
        let isDead = false;
        let estimatedAge = 0; // è©•ä¾¡ç”¨ã®æ¨¹é½¢

        const DEAD_THRESHOLD = 14 * 24 * 60 * 60 * 1000; // 14æ—¥é–“ï¼ˆãƒŸãƒªç§’ï¼‰

        async function connect() {
            if (!window.ethereum) return;
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];
                loadData();
                checkDeath();
                document.getElementById('title-screen').style.display = 'none';
                document.getElementById('game-screen').style.display = 'block';
                updateUI();
            } catch (e) { console.error(e); }
        }

        function checkDeath() {
            const now = Date.now();
            if (now - lastWatered > DEAD_THRESHOLD) {
                isDead = true;
            }
        }

        function actionWater() {
            if (isDead) {
                alert("ã“ã®ç›†æ ½ã¯æ¯ã‚Œã¦ã„ã¾ã™ã€‚ãƒ‰ãƒ©ã‚¤ç›†æ ½ã¨ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            gp += 10;
            lastWatered = Date.now();
            
            // å…‰ã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            const el = document.getElementById('bonsai-display');
            el.classList.remove('shine-effect');
            void el.offsetWidth; // ãƒªãƒ•ãƒ­ãƒ¼
            el.classList.add('shine-effect');

            document.getElementById('msg-box').innerText = "æ°´ã‚„ã‚Šã‚’ã—ã¦GPã‚’ç²å¾—ã—ã¾ã—ãŸï¼";
            saveData();
            updateUI();
        }

        function actionGrow() {
            if (gp < 50) return;
            gp -= 50;
            estimatedAge += 5; // æˆé•·ãƒœã‚¿ãƒ³ã§è©•ä¾¡ä¸Šã®æ¨¹é½¢ãŒå¢—ãˆã‚‹
            
            document.getElementById('msg-box').innerText = "AIã«ã‚ˆã‚‹æ–°å½¢æ…‹ã‚’ç”Ÿæˆä¸­...ï¼ˆå°†æ¥æ©Ÿèƒ½ï¼‰";
            
            // ã“ã“ã§å°†æ¥çš„ã«AI APIã‚’å©ã
            alert("AIé€£æºã®æº–å‚™ãŒæ•´ã„æ¬¡ç¬¬ã€æ–°ã—ã„ç”»åƒãŒç”Ÿæˆã•ã‚Œã¾ã™ï¼");
            
            saveData();
            updateUI();
        }

        function loadData() {
            const data = JSON.parse(localStorage.getItem('bonsai_v3_ai_' + userAddress)) || 
                         { gp: 0, lastWatered: Date.now(), isDead: false, estimatedAge: 0 };
            gp = data.gp;
            lastWatered = data.lastWatered;
            isDead = data.isDead;
            estimatedAge = data.estimatedAge;
        }

        function saveData() {
            localStorage.setItem('bonsai_v3_ai_' + userAddress, JSON.stringify({
                gp: gp, lastWatered: lastWatered, isDead: isDead, estimatedAge: estimatedAge
            }));
        }

        function updateUI() {
            document.getElementById('gp-value').innerText = gp;
            document.getElementById('age-display').innerText = estimatedAge;
            document.getElementById('wallet-addr').innerText = userAddress;
            
            // æˆé•·ãƒœã‚¿ãƒ³ã®æ´»æ€§åŒ–
            document.getElementById('grow-btn').disabled = (gp < 50);

            // çŠ¶æ…‹è¡¨ç¤º
            const display = document.getElementById('bonsai-display');
            const stateBadge = document.getElementById('state-badge');
            const timer = document.getElementById('death-timer');

            if (isDead) {
                display.innerText = "ğŸ‚";
                stateBadge.innerText = "çŠ¶æ…‹: ãƒ‰ãƒ©ã‚¤ç›†æ ½ï¼ˆæ˜‡æ ¼å¯èƒ½ï¼‰";
                stateBadge.style.color = "brown";
                document.getElementById('water-btn').disabled = true;
            } else {
                display.innerText = "ğŸŒ²";
                stateBadge.innerText = "çŠ¶æ…‹: è‰¯å¥½";
                stateBadge.style.color = "green";
                
                // æ¬¡ã«æ¯ã‚Œã‚‹ã¾ã§ã®ç›®å®‰ã‚’è¡¨ç¤º
                const timeLeft = DEAD_THRESHOLD - (Date.now() - lastWatered);
                const daysLeft = Math.ceil(timeLeft / (1000 * 60 * 60 * 24));
                timer.innerText = `ã‚ã¨ ${daysLeft} æ—¥æ°´ã‚„ã‚Šã—ãªã„ã¨æ¯ã‚Œã¾ã™`;
            }
        }

        function resetGame() {
            if(confirm("ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.removeItem('bonsai_v3_ai_' + userAddress);
                location.reload();
            }
        }

        window.onload = () => { document.getElementById('connect-btn').onclick = connect; };
    </script>
</body>
</html>
