<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BONSAI GROWTH - Staking Link</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/@coinbase/wallet-sdk@3.7.1/dist/index.js"></script>
    <style>
        body { text-align: center; background: #f0f4f0; font-family: sans-serif; margin: 0; }
        #title-screen { background: #0052FF; color: white; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #game-screen { display: none; padding: 20px; }
        .status-card { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: inline-block; min-width: 280px; }
        .gp-display { font-size: 28px; color: #2e7d32; font-weight: bold; margin: 5px 0; }
        .bonus-badge { background: #e8f5e9; color: #2e7d32; padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .bonsai-container { font-size: 120px; margin: 30px 0; }
        .btn-water { background: #4caf50; color: white; padding: 15px 40px; font-size: 20px; border-radius: 50px; border: none; cursor: pointer; }
    </style>
</head>
<body>

    <div id="title-screen">
        <div style="font-size: 80px;">ğŸŒ²</div>
        <h1>BONSAI GROWTH</h1>
        <p>Staking Reward System v3.0</p>
        <button id="connect-btn" style="padding: 15px 30px; border-radius: 10px; cursor: pointer; font-weight: bold;">ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã§æ¥ç¶š</button>
    </div>

    <div id="game-screen">
        <div class="status-card">
            <div id="rank-display" style="font-weight: bold; color: #666;">RANK: è‹—æœ¨</div>
            <div class="gp-display"><span id="gp-value">0</span> GP</div>
            <div id="bonus-info" class="bonus-badge">Staking Bonus: +0.0000 GP</div>
        </div>

        <div id="bonsai-display" class="bonsai-container">ğŸŒ±</div>

        <h2>æ¨¹é½¢: <span id="age-display">0</span> æ—¥</h2>
        
        <button id="water-btn" class="btn-water" onclick="actionWater()">ğŸ’§ æ°´ã‚„ã‚Š</button>
        
        <p id="msg-box" style="margin-top: 20px; color: #555; font-size: 14px;"></p>
        <p id="wallet-addr" style="font-size: 10px; opacity: 0.5; margin-top: 30px;"></p>

        <button onclick="resetGame()" style="margin-top: 20px; opacity: 0.3;">ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <script>
        const BONSAI_BANK_ADDR = "0xb447894a8FE006Fa2caFe16b7B49E7F2c770d08C";
        const ABI = ["function balanceOf(address owner) view returns (uint256)"];
        
        let userAddress = "";
        let gp = 0;
        let age = 0;
        let stakingBonus = 0;
        let provider, ethereum;

        async function connect() {
            if (!window.ethereum) return;
            const coinbaseWalletSDK = new CoinbaseWalletSDK({ appName: "BONSAI" });
            ethereum = coinbaseWalletSDK.makeWeb3Provider("https://mainnet.base.org", 8453);
            provider = new ethers.providers.Web3Provider(ethereum);

            try {
                const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];
                
                // ã‚¹ãƒ†ãƒ¼ã‚­ãƒ³ã‚°é‡ã‚’ç¢ºèª
                await fetchStakingData();
                
                loadData();
                document.getElementById('title-screen').style.display = 'none';
                document.getElementById('game-screen').style.display = 'block';
                updateUI();
            } catch (e) { console.error(e); }
        }

        async function fetchStakingData() {
            try {
                const contract = new ethers.Contract(BONSAI_BANK_ADDR, ABI, provider);
                const balance = await contract.balanceOf(userAddress);
                const formattedBalance = parseFloat(ethers.utils.formatEther(balance));
                
                // 1å„„åˆ†ã®1ã‚’ãƒœãƒ¼ãƒŠã‚¹ã¨ã—ã¦è¨ˆç®—
                stakingBonus = formattedBalance / 100000000;
                
                document.getElementById('bonus-info').innerText = `Staking Bonus: +${stakingBonus.toFixed(6)} GP`;
            } catch (e) {
                console.log("Staking data fetch error:", e);
                stakingBonus = 0;
            }
        }

        function actionWater() {
            const baseGain = 10;
            const totalGain = baseGain + stakingBonus;
            
            gp += totalGain;
            age += 1;
            
            document.getElementById('msg-box').innerText = `æ°´ã‚„ã‚ŠæˆåŠŸï¼ä»Šå›ç²å¾—: ${totalGain.toFixed(6)} GP`;
            saveData();
            updateUI();
        }

        function loadData() {
            const data = JSON.parse(localStorage.getItem('bonsai_v3_' + userAddress)) || { gp: 0, age: 0 };
            gp = data.gp;
            age = data.age;
        }

        function saveData() {
            localStorage.setItem('bonsai_v3_' + userAddress, JSON.stringify({ gp: gp, age: age }));
        }

        function updateUI() {
            document.getElementById('gp-value').innerText = gp.toFixed(2);
            document.getElementById('age-display').innerText = age;
            document.getElementById('wallet-addr').innerText = userAddress;

            const display = document.getElementById('bonsai-display');
            if (gp >= 100) { display.innerText = "ğŸŒ³"; }
            else if (gp >= 50) { display.innerText = "ğŸŒ²"; }
            else { display.innerText = "ğŸŒ±"; }
        }

        function resetGame() {
            if(confirm("ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.removeItem('bonsai_v3_' + userAddress);
                location.reload();
            }
        }

        window.onload = () => { document.getElementById('connect-btn').onclick = connect; };
    </script>
</body>
</html>
